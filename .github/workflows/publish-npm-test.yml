name: Release Test

on:
  push:
    branches:
      - test
      - snow-flow-test
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0-test.1)'
        required: false
        default: ''

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: write
  packages: write

jobs:
  build-and-publish:
    name: Build All Platforms & Publish
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Upgrade npm (required for OIDC)
        run: npm install -g npm@latest

      - name: Configure npm for OIDC publishing
        run: |
          rm -f ~/.npmrc
          rm -f .npmrc
          rm -f /home/runner/work/_temp/.npmrc 2>/dev/null || true
          echo "registry=https://registry.npmjs.org/" > ~/.npmrc
          echo "//registry.npmjs.org/:_authToken=" >> ~/.npmrc
          echo "✅ npm configured for OIDC"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            BASE_VERSION=$(cat packages/opencode/package.json | grep '"version"' | head -1 | sed 's/.*"version": "\(.*\)".*/\1/')
            echo "version=${BASE_VERSION}-test.${{ github.run_number }}" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: |
          for i in 1 2 3; do
            echo "Attempt $i of 3..."
            if bun install; then
              break
            fi
            sleep 10
          done

      - name: Build ALL platform binaries (cross-compile)
        run: |
          cd packages/opencode

          # Update version in package.json
          VERSION="${{ steps.version.outputs.version }}"
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" package.json

          # Build ALL platforms from Linux (cross-compilation)
          echo "Building all platforms via cross-compilation..."
          bun run build
        env:
          SNOWCODE_CHANNEL: test

      - name: Rename output directories
        run: |
          cd packages/opencode/dist

          # Find all built directories and rename for snow-flow-test
          for dir in */; do
            if [ -d "$dir" ]; then
              # Replace snow-code with snow-flow-test in dir name
              new_name=$(echo "$dir" | sed 's/snow-code/snow-flow-test/' | sed 's/opencode/snow-flow-test/')
              if [ "$dir" != "$new_name" ]; then
                echo "Renaming $dir to $new_name"
                mv "$dir" "$new_name"
              fi
            fi
          done

          echo "Built platforms:"
          ls -la

      - name: Prepare package for publishing
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd packages/opencode

          # Update package.json for test release
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));

            // Change name and version, remove private flag
            pkg.name = 'snow-flow-test';
            pkg.version = '$VERSION';
            pkg.description = 'Snow-Flow Test - ServiceNow Multi-Agent Development Framework';
            pkg.private = false;

            // Set repository for OIDC provenance verification
            pkg.repository = {
              type: 'git',
              url: 'https://github.com/groeimetai/snow-flow'
            };

            // Update bin commands
            pkg.bin = {
              'snow-flow-test': './bin/snow-code',
              'snow-code-test': './bin/snow-code'
            };

            // Remove workspace dependencies
            if (pkg.devDependencies) {
              Object.keys(pkg.devDependencies).forEach(key => {
                if (pkg.devDependencies[key].includes('workspace:')) {
                  delete pkg.devDependencies[key];
                }
              });
            }
            if (pkg.dependencies) {
              Object.keys(pkg.dependencies).forEach(key => {
                if (pkg.dependencies[key].includes('workspace:')) {
                  delete pkg.dependencies[key];
                }
              });
            }

            // Remove optionalDependencies - platform packages can't use OIDC
            delete pkg.optionalDependencies;

            // Add postinstall script to download binary from GitHub releases
            pkg.scripts = pkg.scripts || {};
            pkg.scripts.postinstall = 'node scripts/postinstall.js';

            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "

          echo "Updated package.json:"
          cat package.json

      - name: Create postinstall script
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p packages/opencode/scripts

          cat > packages/opencode/scripts/postinstall.js << 'EOF'
#!/usr/bin/env node
const https = require('https');
const fs = require('fs');
const path = require('path');
const os = require('os');
const { execSync } = require('child_process');

const pkg = require('../package.json');
const VERSION = pkg.version;
const REPO = 'groeimetai/snow-flow';

const platformMap = { darwin: 'darwin', linux: 'linux', win32: 'windows' };
const archMap = { x64: 'x64', arm64: 'arm64' };

const platform = platformMap[os.platform()] || os.platform();
const arch = archMap[os.arch()] || os.arch();
const tarballName = 'snow-flow-test-' + platform + '-' + arch + '.tar.gz';

const pkgDir = path.join(__dirname, '..');
const binaryName = platform === 'windows' ? 'opencode.exe' : 'opencode';
const binaryPath = path.join(pkgDir, 'bin', binaryName);

if (fs.existsSync(binaryPath)) {
  console.log('snow-flow-test: Binary already exists');
  process.exit(0);
}

const releaseUrl = 'https://github.com/' + REPO + '/releases/download/v' + VERSION + '/' + tarballName;
console.log('snow-flow-test: Downloading binary for ' + platform + '-' + arch + '...');

function followRedirects(url, callback) {
  https.get(url, { headers: { 'User-Agent': 'snow-flow-test' } }, function(res) {
    if (res.statusCode === 302 || res.statusCode === 301) {
      followRedirects(res.headers.location, callback);
    } else {
      callback(res);
    }
  });
}

var tmpDir = fs.mkdtempSync(path.join(os.tmpdir(), 'snow-flow-'));
var tarPath = path.join(tmpDir, tarballName);
var file = fs.createWriteStream(tarPath);

followRedirects(releaseUrl, function(res) {
  if (res.statusCode !== 200) {
    console.warn('snow-flow-test: Could not download binary (HTTP ' + res.statusCode + ')');
    console.warn('snow-flow-test: Download manually from: https://github.com/' + REPO + '/releases');
    process.exit(0);
  }

  res.pipe(file);
  file.on('finish', function() {
    file.close();
    try {
      execSync('tar -xzf "' + tarPath + '" -C "' + pkgDir + '"', { stdio: 'pipe' });
      if (platform !== 'windows' && fs.existsSync(binaryPath)) {
        fs.chmodSync(binaryPath, 493);
      }
      console.log('snow-flow-test: Binary installed successfully!');
    } catch (e) {
      console.warn('snow-flow-test: Could not extract binary');
    }
    try { fs.rmSync(tmpDir, { recursive: true }); } catch (e) {}
  });
});
EOF

          echo "Created postinstall.js"

      - name: Create platform tarballs
        run: |
          cd packages/opencode/dist

          for dir in snow-flow-test-*/; do
            if [ -d "$dir" ]; then
              platform_name=$(basename "$dir")
              echo "Creating tarball for $platform_name..."
              # Create tarball with bin/ directory structure
              tar -czf "${platform_name}.tar.gz" -C "$dir" bin
              echo "Created ${platform_name}.tar.gz"
            fi
          done

          ls -la *.tar.gz 2>/dev/null || echo "No tarballs created"

      - name: Update bin launcher script
        run: |
          cat > packages/opencode/bin/snow-code << 'EOF'
#!/usr/bin/env node

const childProcess = require("child_process")
const fs = require("fs")
const path = require("path")
const os = require("os")

function run(target) {
  const result = childProcess.spawnSync(target, process.argv.slice(2), {
    stdio: "inherit",
  })
  if (result.error) {
    console.error(result.error.message)
    process.exit(1)
  }
  const code = typeof result.status === "number" ? result.status : 0
  process.exit(code)
}

// Check for environment override
const envPath = process.env.SNOW_CODE_BIN_PATH || process.env.OPENCODE_BIN_PATH
if (envPath && fs.existsSync(envPath)) {
  run(envPath)
}

const scriptPath = fs.realpathSync(__filename)
const scriptDir = path.dirname(scriptPath)
const pkgDir = path.dirname(scriptDir)

const platformMap = { darwin: "darwin", linux: "linux", win32: "windows" }
const archMap = { x64: "x64", arm64: "arm64", arm: "arm" }

let platform = platformMap[os.platform()] || os.platform()
let arch = archMap[os.arch()] || os.arch()

const binaryName = platform === "windows" ? "opencode.exe" : "opencode"

// First check: binary in our own bin directory (from postinstall download)
const localBinary = path.join(scriptDir, binaryName)
if (fs.existsSync(localBinary)) {
  run(localBinary)
}

// Second check: look in node_modules for platform packages
const snowBase = "snow-flow-test-" + platform + "-" + arch
const openBase = "opencode-" + platform + "-" + arch

function findInNodeModules(startDir) {
  let current = startDir
  for (;;) {
    const modules = path.join(current, "node_modules")
    if (fs.existsSync(modules)) {
      const entries = fs.readdirSync(modules)
      for (const entry of entries) {
        if (entry.startsWith(snowBase) || entry.startsWith(openBase)) {
          const candidate = path.join(modules, entry, "bin", binaryName)
          if (fs.existsSync(candidate)) {
            return candidate
          }
        }
      }
    }
    const parent = path.dirname(current)
    if (parent === current) break
    current = parent
  }
}

const resolved = findInNodeModules(scriptDir)
if (resolved) {
  run(resolved)
}

console.error("snow-flow-test: Binary not found for " + platform + "-" + arch)
console.error("Try running: npm rebuild snow-flow-test")
console.error("Or download manually from: https://github.com/groeimetai/snow-flow/releases")
process.exit(1)
EOF

          chmod +x packages/opencode/bin/snow-code
          echo "Updated bin/snow-code launcher"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Snow-Flow Test v${{ steps.version.outputs.version }}
          prerelease: true
          generate_release_notes: false
          files: |
            packages/opencode/dist/*.tar.gz
          body: |
            ## Snow-Flow Test Release (TypeScript)

            This is a **pure TypeScript** test release - no Go dependencies!

            ### Install
            ```bash
            npm install -g snow-flow-test@${{ steps.version.outputs.version }}
            ```

            ### Run
            ```bash
            snow-flow-test
            # or
            snow-code-test
            ```

            ### Supported Platforms
            - ✅ Linux x64
            - ✅ Linux arm64
            - ✅ macOS arm64 (Apple Silicon)
            - ✅ macOS x64 (Intel)
            - ✅ Windows x64

            ### What's New
            - 100% TypeScript (SolidJS + OpenTUI)
            - No Go binary compilation needed
            - All 373+ ServiceNow MCP tools
            - All 53 bundled skills
            - 8 auth types (ServiceNow OAuth, Enterprise, Portal, MID Server, etc.)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish main package to npm (OIDC)
        run: |
          cd packages/opencode
          echo "Publishing snow-flow-test main package..."
          npm publish --access public --tag test --provenance

      # Platform binaries are distributed via GitHub releases
      # Users can download from: https://github.com/groeimetai/snow-flow/releases
