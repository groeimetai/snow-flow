FROM oven/bun:1.3 AS base

WORKDIR /app

# Install system dependencies for bun-pty, git for project detection, npm for user installs
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    make \
    g++ \
    git \
    npm \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Copy package files and patches for dependency resolution
COPY package.json bun.lock turbo.json ./
COPY patches/ patches/

# Copy all workspace package.json files (bun requires all workspaces present)
COPY packages/opencode/package.json packages/opencode/
COPY packages/util/package.json packages/util/
COPY packages/plugin/package.json packages/plugin/
COPY packages/sdk/js/package.json packages/sdk/js/
COPY packages/ui/package.json packages/ui/
COPY packages/app/package.json packages/app/
COPY packages/desktop/package.json packages/desktop/
COPY packages/enterprise/package.json packages/enterprise/
COPY packages/function/package.json packages/function/
COPY packages/script/package.json packages/script/
COPY packages/slack/package.json packages/slack/
COPY packages/console/app/package.json packages/console/app/
COPY packages/console/core/package.json packages/console/core/
COPY packages/console/function/package.json packages/console/function/
COPY packages/console/mail/package.json packages/console/mail/
COPY packages/console/resource/package.json packages/console/resource/
COPY packages/mobile/package.json packages/mobile/

# Copy postinstall script needed by bun install
COPY packages/opencode/scripts/ packages/opencode/scripts/

# Install dependencies
RUN bun install --frozen-lockfile

# Copy source
COPY packages/opencode/ packages/opencode/
COPY packages/util/ packages/util/
COPY packages/plugin/ packages/plugin/
COPY packages/sdk/js/ packages/sdk/js/
COPY packages/ui/ packages/ui/
COPY packages/app/ packages/app/

# Build the web app (static HTML/JS/CSS)
# VITE_SNOW_FLOW_HOSTED tells the app to use window.location.origin as API endpoint
# instead of redirecting to localhost:4096 on snow-flow.dev domains
ENV VITE_SNOW_FLOW_HOSTED=true
RUN bun run --cwd packages/app build

# Create snow-flow CLI wrapper that runs from source
# Default TUI mode uses --connect to share sessions with the web UI server
# Subcommands (run, serve, etc.) pass through directly
RUN printf '#!/bin/sh\ncd /app\ncase "${1:-}" in\n  run|serve|web|auth|agent|attach|models|debug|stats|export|import|mcp|github|pr|session|upgrade|uninstall|completion|acp|thread)\n    exec bun run --conditions=browser packages/opencode/src/index.ts "$@"\n    ;;\n  *)\n    exec bun run --conditions=browser packages/opencode/src/index.ts --connect http://localhost:4096 "$@"\n    ;;\nesac\n' > /usr/local/bin/snow-flow && \
    chmod +x /usr/local/bin/snow-flow && \
    ln -s /usr/local/bin/snow-flow /usr/local/bin/snow-code

# Create workspace with git repo and starter files
RUN mkdir -p /workspace && \
    git init /workspace && \
    printf '# My Project\n\nUse `snow-flow` in the terminal to get started.\n\n> **Note:** This workspace is ephemeral. Files are lost when your session ends.\n> Maximum workspace size: 512MB.\n' > /workspace/README.md && \
    cd /workspace && git add -A && git -c user.name="Snow-Flow" -c user.email="noreply@snow-flow.dev" commit -m "initial workspace"

# Set terminal environment
ENV TERM=xterm-256color
ENV COLORTERM=truecolor
ENV FORCE_COLOR=3
ENV NODE_ENV=production
# Disable default plugin npm installs — no need in headless serve mode
ENV OPENCODE_DISABLE_DEFAULT_PLUGINS=true
# Disable opencode/zen provider in hosted TUI
ENV OPENCODE_CONFIG_CONTENT='{"disabled_providers":["opencode"]}'
# Default directory for file browser and terminal
ENV SNOW_CODE_DEFAULT_DIRECTORY=/workspace
# Fix TUI rendering in web terminal (Ghostty WebGL doesn't support kitty keyboard)
ENV OPENCODE_DISABLE_KITTY_KEYBOARD=1
# Skip terminal theme detection in hosted environment
ENV OPENCODE_SKIP_THEME_DETECTION=1
# Disable alternate screen buffer — PTY over WebSocket doesn't need it
ENV OTUI_USE_ALTERNATE_SCREEN=0
# Debug opentui renderer
ENV OTUI_DEBUG=1
# Auto-start snow-flow TUI when terminal opens (PTY reads $SHELL)
ENV SHELL=/usr/local/bin/snow-flow

EXPOSE 4096

CMD ["bun", "run", "--conditions=browser", "/app/packages/opencode/src/index.ts", "serve", \
     "--hostname", "0.0.0.0", "--port", "4096"]
