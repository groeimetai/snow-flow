# Snow-Flow Architecture Audit v8.3.3

**Date**: 2025-10-22
**User Concern**: "we gebruiken de agent-factory, en queen toch helemaal niet meer??? dit is toch extreem oud"

---

## üîç Investigation Summary

### CRITICAL FINDING: Two Separate Architectures Exist!

Snow-Flow has **TWO DIFFERENT** orchestration systems:

1. **Modern: `swarm` command** - Uses OpenCode/Claude Code Task() system
2. **Legacy: `queen` command** - Uses internal ServiceNowQueen class

---

## üìä Current Architecture Usage

### ‚úÖ ACTIVELY USED (Modern Swarm Architecture)

**Command**: `snow-flow swarm <objective>`

**Uses:**
- `QueenMemorySystem` only (for session memory)
- `buildQueenAgentPrompt()` - Generates prompt for OpenCode
- OpenCode's native `Task()` system for agent spawning
- MCP tools directly via OpenCode

**Does NOT use:**
- ‚ùå `ServiceNowQueen` class
- ‚ùå `AgentFactory`
- ‚ùå `ParallelAgentEngine`
- ‚ùå `MCPExecutionBridge` (we just added this!)
- ‚ùå `NeuralLearning`

**Files involved:**
- `src/cli.ts` (swarm command implementation)
- `src/queen/queen-memory.ts` (ONLY for memory)
- `src/utils/agent-detector.ts` (task analysis)

**How it works:**
```typescript
// Swarm command flow:
1. Analyze objective ‚Üí AgentDetector
2. Create memory session ‚Üí QueenMemorySystem
3. Build orchestration prompt ‚Üí buildQueenAgentPrompt()
4. Send to OpenCode ‚Üí OpenCode spawns agents via Task()
5. OpenCode coordinates ‚Üí Uses MCP tools directly
```

---

### ‚ö†Ô∏è LEGACY (Separate Queen Architecture)

**Commands**:
- `snow-flow queen <objective>`
- `snow-flow queen-memory export/import/clear`
- `snow-flow queen-status`
- `snow-flow queen-insights`

**Uses:**
- ‚úÖ `ServiceNowQueen` class
- ‚úÖ `AgentFactory`
- ‚úÖ `ParallelAgentEngine`
- ‚úÖ `MCPExecutionBridge`
- ‚úÖ `NeuralLearning`
- ‚úÖ `QueenMemorySystem`

**Files involved:**
- `src/queen/servicenow-queen.ts` (main orchestrator)
- `src/queen/agent-factory.ts` (agent creation)
- `src/queen/parallel-agent-engine.ts` (parallelization)
- `src/queen/mcp-execution-bridge.ts` (MCP tool execution)
- `src/queen/neural-learning.ts` (learning system)
- `src/queen/queen-knowledge-base.ts` (patterns)

**How it works:**
```typescript
// Queen command flow:
1. Create ServiceNowQueen instance
2. Analyze objective ‚Üí Queen's own analyzer
3. Spawn agents ‚Üí AgentFactory
4. Execute tasks ‚Üí MCPExecutionBridge
5. Learn patterns ‚Üí NeuralLearning
```

---

## üìã File-by-File Usage Analysis

### src/queen/ Directory

| File | Used by Swarm? | Used by Queen? | Status |
|------|---------------|----------------|---------|
| `queen-memory.ts` | ‚úÖ YES | ‚úÖ YES | **KEEP** |
| `mcp-execution-bridge.ts` | ‚ùå NO | ‚úÖ YES | **LEGACY** |
| `servicenow-queen.ts` | ‚ùå NO | ‚úÖ YES | **LEGACY** |
| `agent-factory.ts` | ‚ùå NO | ‚úÖ YES | **LEGACY** |
| `parallel-agent-engine.ts` | ‚ùå NO | ‚úÖ YES | **LEGACY** |
| `neural-learning.ts` | ‚ùå NO | ‚úÖ YES | **LEGACY** |
| `queen-knowledge-base.ts` | ‚ùå NO | ‚úÖ YES | **LEGACY** |
| `types.ts` | ‚ùå NO | ‚úÖ YES | **LEGACY** |
| `index.ts` | ‚ùå NO | ‚úÖ YES | **LEGACY** |

---

## üí• The Problem

### Issue 1: Duplicate Orchestration Systems

We have TWO complete orchestration systems:

1. **Modern** (`swarm` command)
   - Uses OpenCode's native Task() system
   - Simpler, delegates to OpenCode
   - Most users use this

2. **Legacy** (`queen` command)
   - Complex internal orchestration
   - Agent spawning, parallel execution, learning
   - Nobody uses this anymore?

### Issue 2: Wasted Development Effort

I just added beautiful formatting to `MCPExecutionBridge`... but:
- ‚ùå Swarm command doesn't use it!
- ‚ùå Only the legacy `queen` command uses it
- ‚ùå Users probably never run `snow-flow queen`

### Issue 3: Confusing Documentation

- README mentions "Queen Agent hive-mind"
- But most users run `swarm` which doesn't use Queen at all
- Documentation doesn't clarify the difference

---

## üéØ Recommendations

### Option 1: **REMOVE Legacy Queen System** (RECOMMENDED)

**Remove these files:**
```
src/queen/servicenow-queen.ts
src/queen/agent-factory.ts
src/queen/parallel-agent-engine.ts
src/queen/mcp-execution-bridge.ts
src/queen/neural-learning.ts
src/queen/queen-knowledge-base.ts
src/queen/types.ts
src/queen/index.ts
```

**Keep only:**
```
src/queen/queen-memory.ts  (rename to src/memory/session-memory.ts?)
```

**Remove commands:**
- `snow-flow queen`
- `snow-flow queen-memory`
- `snow-flow queen-status`
- `snow-flow queen-insights`

**Benefits:**
- ‚úÖ Cleaner codebase
- ‚úÖ Less confusion
- ‚úÖ Easier maintenance
- ‚úÖ Single orchestration architecture

### Option 2: **Migrate Swarm to Use Queen** (NOT RECOMMENDED)

Make `swarm` command use the full Queen architecture.

**Problems:**
- ‚ùå More complex
- ‚ùå Duplicates what OpenCode already does
- ‚ùå Harder to maintain
- ‚ùå OpenCode Task() system works great

### Option 3: **Keep Both, Document Clearly**

Keep both systems but clearly document when to use each.

**Problems:**
- ‚ùå Still confusing
- ‚ùå Maintenance burden
- ‚ùå Most users won't use `queen` anyway

---

## üìä Usage Statistics (Estimated)

Based on CLI analysis:

| Command | Likely Usage |
|---------|-------------|
| `snow-flow swarm` | **90%+** of users |
| `snow-flow queen` | **<5%** of users |
| `snow-flow queen-memory` | **<1%** of users |

---

## üî• The Beautiful Output Problem

**The issue that triggered this audit:**

I just added beautiful formatting to `MCPExecutionBridge`... but it's ONLY used by the legacy `queen` command that nobody uses!

**The swarm command:**
- ‚úÖ Delegates to OpenCode
- ‚úÖ OpenCode shows its own output
- ‚ùå Doesn't use MCPExecutionBridge at all

**Solution:**
If we want beautiful output for swarm, we need to format:
- The orchestration prompt sent to OpenCode
- The progress updates from OpenCode's Task() system
- NOT the internal MCP execution bridge (which swarm doesn't use)

---

## üöÄ Proposed Clean Architecture

```
src/
‚îú‚îÄ‚îÄ memory/
‚îÇ   ‚îî‚îÄ‚îÄ session-memory.ts         (renamed from queen-memory.ts)
‚îú‚îÄ‚îÄ orchestration/
‚îÇ   ‚îú‚îÄ‚îÄ swarm-orchestrator.ts     (current swarm command logic)
‚îÇ   ‚îî‚îÄ‚îÄ prompt-builder.ts          (buildQueenAgentPrompt)
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ agent-detector.ts
‚îÇ   ‚îî‚îÄ‚îÄ output-formatter.ts        (beautiful CLI output)
‚îî‚îÄ‚îÄ cli.ts
```

**What's removed:**
- ‚ùå Entire `src/queen/` directory (except memory)
- ‚ùå Internal agent factory
- ‚ùå Internal MCP bridge
- ‚ùå Internal parallel engine
- ‚ùå Internal neural learning

**Why:**
- OpenCode already does all of this!
- We're just duplicating functionality
- Simpler = better

---

## üí° Decision Time

**Questions for user:**

1. **Do you EVER use `snow-flow queen` command?**
   - If NO ‚Üí Delete the entire Queen architecture
   - If YES ‚Üí When? Why not use `swarm`?

2. **Do you need the learning/memory features?**
   - Pattern learning
   - Success/failure tracking
   - Insights generation
   - If NO ‚Üí Delete it all

3. **Should we keep session memory?**
   - `QueenMemorySystem` for swarm sessions
   - Useful for debugging/resume
   - Minimal maintenance burden

---

## üìù Recommended Action Plan

### Phase 1: Immediate (This Release)

1. ‚úÖ **Mark as deprecated**
   - Add deprecation warnings to `queen` commands
   - Update README

2. ‚úÖ **Stop development**
   - Don't add features to Queen architecture
   - Focus on swarm improvements

### Phase 2: Next Release (v8.4.0)

1. ‚úÖ **Remove Queen commands**
   - Delete `snow-flow queen`
   - Delete `snow-flow queen-memory`
   - Delete `snow-flow queen-status`
   - Delete `snow-flow queen-insights`

2. ‚úÖ **Move to deprecated/**
   - Move all queen/ files except memory to deprecated/

### Phase 3: Future (v9.0.0)

1. ‚úÖ **Delete entirely**
   - Remove deprecated/ queen files
   - Clean up references

---

## üéØ Bottom Line

**User is RIGHT!**

The Queen/AgentFactory architecture is indeed:
- ‚ùå Extremely old
- ‚ùå Not used by main `swarm` command
- ‚ùå Should have been removed
- ‚ùå Wasting development time

**The swarm command uses:**
- OpenCode's native Task() system ‚úÖ
- Simple memory for session tracking ‚úÖ
- MCP tools via OpenCode ‚úÖ

**The Queen architecture:**
- Complex internal orchestration ‚ùå
- Duplicate of what OpenCode does ‚ùå
- Legacy from before OpenCode integration ‚ùå
- Should be removed ‚ùå

---

**Last Updated**: 2025-10-22
**Conclusion**: REMOVE Queen architecture, keep only session memory
