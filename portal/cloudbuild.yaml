# Cloud Build Configuration for Snow-Flow Enterprise Portal
#
# Builds and deploys the portal service (frontend + backend APIs)
# to portal.snow-flow.dev
#
# Required substitution variables:
#   _REGION: GCP region (default: europe-west4)
#   _SERVICE_NAME: Cloud Run service name (default: snow-flow-portal)
#   _ARTIFACT_REGISTRY_REPO: Artifact Registry repo (default: snow-flow-enterprise)

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'
  substitutionOption: 'ALLOW_LOOSE'

substitutions:
  _REGION: 'europe-west4'
  _SERVICE_NAME: 'snow-flow-portal'
  _ARTIFACT_REGISTRY_REPO: 'snow-flow-enterprise'
  _MIN_INSTANCES: '1'
  _MAX_INSTANCES: '10'
  _MEMORY: '1Gi'
  _CPU: '2'
  _CONCURRENCY: '100'
  _TIMEOUT: '300s'

steps:
  # Step 1: Build Docker image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REGISTRY_REPO}/${_SERVICE_NAME}:$COMMIT_SHA'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REGISTRY_REPO}/${_SERVICE_NAME}:latest'
      - '--cache-from'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REGISTRY_REPO}/${_SERVICE_NAME}:latest'
      - '--build-arg'
      - 'BUILDKIT_INLINE_CACHE=1'
      - '.'
    dir: 'portal'
    timeout: '600s'

  # Step 2: Push Docker image (SHA tag)
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image-sha'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REGISTRY_REPO}/${_SERVICE_NAME}:$COMMIT_SHA'
    waitFor: ['build-image']

  # Step 3: Push Docker image (latest tag)
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image-latest'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REGISTRY_REPO}/${_SERVICE_NAME}:latest'
    waitFor: ['build-image']

  # Step 4: Update Cloud Run service image
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'update-cloud-run-image'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'services'
      - 'update'
      - '${_SERVICE_NAME}'
      - '--image=${_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REGISTRY_REPO}/${_SERVICE_NAME}:$COMMIT_SHA'
      - '--region=${_REGION}'
      - '--platform=managed'
    waitFor: ['push-image-sha', 'push-image-latest']

  # Step 5: Update service configuration
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'update-cloud-run-config'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'services'
      - 'update'
      - '${_SERVICE_NAME}'
      - '--region=${_REGION}'
      - '--platform=managed'
      - '--min-instances=${_MIN_INSTANCES}'
      - '--max-instances=${_MAX_INSTANCES}'
      - '--memory=${_MEMORY}'
      - '--cpu=${_CPU}'
      - '--concurrency=${_CONCURRENCY}'
      - '--timeout=${_TIMEOUT}'
      - '--port=8080'
    waitFor: ['update-cloud-run-image']

  # Step 6: Verify deployment health
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'verify-deployment'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        SERVICE_URL=$$(gcloud run services describe ${_SERVICE_NAME} \
          --region=${_REGION} \
          --format='value(status.url)')

        echo "üåê Service URL: $$SERVICE_URL"

        for i in {1..12}; do
          echo "üè• Health check attempt $$i/12..."
          if curl -f -s "$$SERVICE_URL/health" > /dev/null 2>&1; then
            echo "‚úÖ Portal health check passed!"
            curl -s "$$SERVICE_URL/health" | jq .
            exit 0
          fi
          echo "‚è≥ Waiting 5 seconds..."
          sleep 5
        done

        echo "‚ùå Portal health check failed after 60 seconds"
        exit 1
    waitFor: ['update-cloud-run-config']

# Store built images
images:
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REGISTRY_REPO}/${_SERVICE_NAME}:$COMMIT_SHA'
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REGISTRY_REPO}/${_SERVICE_NAME}:latest'

# Build timeout
timeout: '900s'

# Tags
tags:
  - 'snow-flow-enterprise'
  - 'portal'
  - '${_SERVICE_NAME}'
