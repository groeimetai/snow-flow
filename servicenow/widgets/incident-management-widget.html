<!-- ServiceNow Incident Management Widget with Enhanced Visuals -->
<div class="incident-widget" ng-controller="IncidentWidgetController">
  <!-- Widget Header -->
  <div class="widget-header">
    <div class="widget-title">
      <div class="widget-title-icon">
        <i class="fa fa-exclamation-triangle"></i>
      </div>
      <h2>{{data.title || 'Incident Management Dashboard'}}</h2>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" ng-click="c.refresh()" ng-disabled="c.loading">
        <i class="fa fa-refresh" ng-class="{'fa-spin': c.loading}"></i>
        Refresh
      </button>
      <button class="btn btn-secondary" ng-click="c.exportData()">
        <i class="fa fa-download"></i>
        Export
      </button>
    </div>
  </div>

  <!-- Search and Filter Bar -->
  <div class="search-filter-bar">
    <input type="text" 
           class="search-input" 
           placeholder="Search incidents by number, description, or caller..."
           ng-model="c.filters.searchTerm"
           ng-change="c.onFilterChange()"
           ng-model-options="{debounce: 300}">
    
    <select class="filter-dropdown" 
            ng-model="c.selectedPriority" 
            ng-change="c.filterIncidents()">
      <option value="">All Priorities</option>
      <option value="1">Critical</option>
      <option value="2">High</option>
      <option value="3">Medium</option>
      <option value="4">Low</option>
    </select>
    
    <select class="filter-dropdown" 
            ng-model="c.selectedState" 
            ng-change="c.filterIncidents()">
      <option value="">All States</option>
      <option value="1">New</option>
      <option value="2">In Progress</option>
      <option value="3">On Hold</option>
      <option value="6">Resolved</option>
      <option value="7">Closed</option>
    </select>
    
    <select class="filter-dropdown" 
            ng-model="c.selectedGroup" 
            ng-change="c.filterIncidents()">
      <option value="">All Groups</option>
      <option ng-repeat="group in c.assignmentGroups" value="{{group.sys_id}}">{{group.name}}</option>
    </select>
  </div>

  <!-- Summary Cards Section -->
  <div class="summary-cards-section">
    <div class="summary-cards">
      <div class="summary-card priority-critical" ng-click="c.filterByPriority('1')">
        <div class="card-icon">
          <i class="fa fa-exclamation-triangle"></i>
        </div>
        <div class="card-content">
          <div class="card-number">{{data.summary.critical || 0}}</div>
          <div class="card-label">Critical</div>
          <div class="card-trend" ng-if="data.summary.criticalTrend">
            <i class="fa" ng-class="data.summary.criticalTrend > 0 ? 'fa-arrow-up' : 'fa-arrow-down'"></i>
            {{Math.abs(data.summary.criticalTrend)}}%
          </div>
        </div>
      </div>
      
      <div class="summary-card priority-high" ng-click="c.filterByPriority('2')">
        <div class="card-icon">
          <i class="fa fa-exclamation-circle"></i>
        </div>
        <div class="card-content">
          <div class="card-number">{{data.summary.high || 0}}</div>
          <div class="card-label">High</div>
          <div class="card-trend" ng-if="data.summary.highTrend">
            <i class="fa" ng-class="data.summary.highTrend > 0 ? 'fa-arrow-up' : 'fa-arrow-down'"></i>
            {{Math.abs(data.summary.highTrend)}}%
          </div>
        </div>
      </div>
      
      <div class="summary-card priority-medium" ng-click="c.filterByPriority('3')">
        <div class="card-icon">
          <i class="fa fa-info-circle"></i>
        </div>
        <div class="card-content">
          <div class="card-number">{{data.summary.medium || 0}}</div>
          <div class="card-label">Medium</div>
          <div class="card-trend" ng-if="data.summary.mediumTrend">
            <i class="fa" ng-class="data.summary.mediumTrend > 0 ? 'fa-arrow-up' : 'fa-arrow-down'"></i>
            {{Math.abs(data.summary.mediumTrend)}}%
          </div>
        </div>
      </div>
      
      <div class="summary-card priority-low" ng-click="c.filterByPriority('4')">
        <div class="card-icon">
          <i class="fa fa-minus-circle"></i>
        </div>
        <div class="card-content">
          <div class="card-number">{{data.summary.low || 0}}</div>
          <div class="card-label">Low</div>
          <div class="card-trend" ng-if="data.summary.lowTrend">
            <i class="fa" ng-class="data.summary.lowTrend > 0 ? 'fa-arrow-up' : 'fa-arrow-down'"></i>
            {{Math.abs(data.summary.lowTrend)}}%
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="charts-section" ng-if="options.show_charts !== 'false'">
    <div class="charts-container">
      <div class="chart-wrapper">
        <h3>Status Distribution</h3>
        <canvas id="statusChart-{{$id}}" width="300" height="150"></canvas>
      </div>
      
      <div class="chart-wrapper">
        <h3>Priority Breakdown</h3>
        <canvas id="priorityChart-{{$id}}" width="300" height="150"></canvas>
      </div>
      
      <div class="chart-wrapper" ng-if="c.trendData.length > 0">
        <h3>7-Day Trend</h3>
        <canvas id="trendChart-{{$id}}" width="300" height="150"></canvas>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-spinner" ng-if="c.loading">
    <div class="spinner"></div>
    <p>Loading incidents...</p>
  </div>

  <!-- Error State -->
  <div class="error-state" ng-if="data.error">
    <div class="error-icon">
      <i class="fa fa-exclamation-triangle"></i>
    </div>
    <h3>Error Loading Data</h3>
    <p>{{data.error}}</p>
    <button class="btn btn-primary" ng-click="c.refresh()">
      <i class="fa fa-refresh"></i>
      Try Again
    </button>
  </div>

  <!-- Enhanced Incidents Grid -->
  <div class="incidents-grid" ng-if="!c.loading && !data.error">
    <div class="incident-card {{c.getCardClass(incident)}}" 
         ng-repeat="incident in c.filteredIncidents | limitTo: c.displayLimit"
         ng-click="c.openIncident(incident)">
      
      <div class="card-header">
        <a href="/nav_to.do?uri=incident.do?sys_id={{incident.sys_id}}" 
           class="incident-number" 
           ng-click="c.openIncident(incident, $event)"
           target="_blank">
          {{incident.number}}
        </a>
        <span class="priority-badge {{c.getPriorityClass(incident.priority)}}">
          {{incident.priority_label}}
        </span>
      </div>
      
      <div class="card-content">
        <h4 class="incident-title">{{incident.short_description}}</h4>
        <div class="incident-details">
          <div class="detail-item">
            <i class="fa fa-user"></i>
            <span>{{incident.assigned_to || 'Unassigned'}}</span>
          </div>
          <div class="detail-item">
            <i class="fa fa-users"></i>
            <span>{{incident.assignment_group || 'No Group'}}</span>
          </div>
          <div class="detail-item">
            <i class="fa fa-tag"></i>
            <span>{{incident.category || 'No Category'}}</span>
          </div>
          <div class="detail-item">
            <i class="fa fa-clock-o"></i>
            <span>{{incident.age_formatted}}</span>
          </div>
        </div>
      </div>
      
      <div class="card-footer">
        <div class="state-indicator">
          <span class="state-badge {{c.getStateClass(incident.state)}}">
            {{incident.state_label}}
          </span>
        </div>
        <div class="update-time">
          <i class="fa fa-clock-o"></i>
          {{incident.updated_at_formatted}}
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" ng-if="!c.loading && !data.error && c.filteredIncidents.length === 0">
    <div class="empty-state-icon">
      <i class="fa fa-check-circle"></i>
    </div>
    <h3 class="empty-state-title">No Incidents Found</h3>
    <p>There are no incidents matching your current filters.</p>
    <button class="btn btn-primary" ng-click="c.clearFilters()">
      <i class="fa fa-filter"></i>
      Clear Filters
    </button>
  </div>

  <!-- Pagination -->
  <div class="pagination-section" ng-if="c.filteredIncidents.length > c.displayLimit">
    <div class="pagination-info">
      Showing {{c.displayLimit}} of {{c.filteredIncidents.length}} incidents
    </div>
    <div class="pagination-controls">
      <button class="btn btn-secondary" 
              ng-click="c.loadMore()" 
              ng-disabled="c.displayLimit >= c.filteredIncidents.length">
        <i class="fa fa-chevron-down"></i>
        Load More
      </button>
      <button class="btn btn-secondary" 
              ng-click="c.showAll()" 
              ng-if="c.displayLimit < c.filteredIncidents.length">
        <i class="fa fa-list"></i>
        Show All ({{c.filteredIncidents.length}})
      </button>
    </div>
  </div>

  <!-- Footer with Enhanced Metadata -->
  <div class="widget-footer" ng-if="data.metadata || options.show_footer">
    <div class="footer-info">
      <span>Last updated: {{data.metadata.last_updated || data.last_updated | date:'medium'}}</span>
      <span class="separator">|</span>
      <span>{{data.metadata.record_count || data.incidents.length}} records</span>
      <span class="separator" ng-if="data.metadata.query_time">|</span>
      <span ng-if="data.metadata.query_time">Query time: {{data.metadata.query_time}}ms</span>
    </div>
  </div>
</div>

<!-- Chart.js Integration -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
  // Chart initialization and management
  (function() {
    var chartInstances = {};
    
    // Initialize charts when data is available
    function initializeCharts(widgetId, data) {
      if (typeof Chart === 'undefined') {
        console.warn('Chart.js not loaded');
        return;
      }
      
      // Status Distribution Doughnut Chart
      var statusCtx = document.getElementById('statusChart-' + widgetId);
      if (statusCtx && data.summary) {
        if (chartInstances['status-' + widgetId]) {
          chartInstances['status-' + widgetId].destroy();
        }
        
        var statusData = [
          data.summary.new || 0,
          data.summary.in_progress || 0,
          data.summary.on_hold || 0,
          data.summary.resolved || 0,
          data.summary.closed || 0
        ];
        
        chartInstances['status-' + widgetId] = new Chart(statusCtx, {
          type: 'doughnut',
          data: {
            labels: ['New', 'In Progress', 'On Hold', 'Resolved', 'Closed'],
            datasets: [{
              data: statusData,
              backgroundColor: ['#ff6b6b', '#ffa500', '#ffff00', '#90ee90', '#d3d3d3'],
              borderWidth: 2,
              borderColor: '#fff',
              hoverBorderWidth: 3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 10,
                  usePointStyle: true
                }
              }
            },
            animation: {
              animateRotate: true,
              animateScale: true
            }
          }
        });
      }
      
      // Priority Breakdown Bar Chart
      var priorityCtx = document.getElementById('priorityChart-' + widgetId);
      if (priorityCtx && data.summary) {
        if (chartInstances['priority-' + widgetId]) {
          chartInstances['priority-' + widgetId].destroy();
        }
        
        var priorityData = [
          data.summary.critical || 0,
          data.summary.high || 0,
          data.summary.medium || 0,
          data.summary.low || 0
        ];
        
        chartInstances['priority-' + widgetId] = new Chart(priorityCtx, {
          type: 'bar',
          data: {
            labels: ['Critical', 'High', 'Medium', 'Low'],
            datasets: [{
              label: 'Incidents',
              data: priorityData,
              backgroundColor: ['#e74c3c', '#f39c12', '#f1c40f', '#2ecc71'],
              borderWidth: 1,
              borderRadius: 4,
              borderSkipped: false
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            },
            animation: {
              duration: 1000,
              easing: 'easeInOutQuart'
            }
          }
        });
      }
      
      // 7-Day Trend Line Chart
      var trendCtx = document.getElementById('trendChart-' + widgetId);
      if (trendCtx && data.trends && data.trends.length > 0) {
        if (chartInstances['trend-' + widgetId]) {
          chartInstances['trend-' + widgetId].destroy();
        }
        
        chartInstances['trend-' + widgetId] = new Chart(trendCtx, {
          type: 'line',
          data: {
            labels: data.trends.map(function(t) { return t.date; }),
            datasets: [{
              label: 'New Incidents',
              data: data.trends.map(function(t) { return t.count; }),
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              tension: 0.3,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            },
            animation: {
              duration: 1200,
              easing: 'easeInOutQuart'
            }
          }
        });
      }
    }
    
    // Global function to update charts
    window.updateIncidentCharts = function(widgetId, data) {
      setTimeout(function() {
        initializeCharts(widgetId, data);
      }, 100);
    };
    
    // Destroy charts on page unload
    window.addEventListener('beforeunload', function() {
      Object.keys(chartInstances).forEach(function(key) {
        if (chartInstances[key]) {
          chartInstances[key].destroy();
        }
      });
    });
  })();
</script>