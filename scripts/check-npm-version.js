#!/usr/bin/env node

/**
 * Check if current package version already exists on npm
 * If it does, automatically bump to next available version
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

function getCurrentVersion() {
  const packageJsonPath = path.join(__dirname, '..', 'package.json');
  const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf-8'));
  return packageJson.version;
}

function getPublishedVersions() {
  try {
    const versionsJson = execSync('npm view snow-flow versions --json', {
      encoding: 'utf8',
      stdio: ['pipe', 'pipe', 'pipe']
    });
    return JSON.parse(versionsJson);
  } catch (error) {
    // Package might not exist yet
    return [];
  }
}

function bumpVersion(type = 'patch') {
  console.log(`üîÑ Bumping ${type} version...`);
  execSync(`npm version ${type} --no-git-tag-version`, {
    stdio: 'inherit',
    cwd: path.join(__dirname, '..')
  });
  return getCurrentVersion();
}

function updateVersionFile(version) {
  const versionFilePath = path.join(__dirname, '..', 'src', 'version.ts');
  const versionContent = `// Auto-generated by npm version command
export const VERSION = '${version}';
`;
  fs.writeFileSync(versionFilePath, versionContent, 'utf-8');
  console.log(`‚úÖ Updated version.ts to ${version}`);
}

async function main() {
  const currentVersion = getCurrentVersion();
  const publishedVersions = getPublishedVersions();

  console.log(`üì¶ Current version: ${currentVersion}`);
  console.log(`üìö Checking npm registry...`);

  if (publishedVersions.includes(currentVersion)) {
    console.log(`‚ö†Ô∏è  Version ${currentVersion} already exists on npm!`);
    console.log(`üîÑ Auto-bumping to next patch version...`);

    const newVersion = bumpVersion('patch');
    updateVersionFile(newVersion);

    console.log(`‚úÖ Bumped to version ${newVersion}`);
    console.log(`üìù Committing version bump...`);

    try {
      execSync('git add package.json src/version.ts', {
        cwd: path.join(__dirname, '..')
      });
      execSync(`git commit -m "chore: Auto-bump version to ${newVersion} (${currentVersion} already published)"`, {
        cwd: path.join(__dirname, '..'),
        stdio: 'inherit'
      });
      console.log(`‚úÖ Version bump committed`);
    } catch (err) {
      console.log(`‚ö†Ô∏è  Git commit failed (might already be committed)`);
    }
  } else {
    console.log(`‚úÖ Version ${currentVersion} is available for publishing`);
  }

  process.exit(0);
}

if (require.main === module) {
  main().catch(error => {
    console.error('‚ùå Error:', error.message);
    process.exit(1);
  });
}

module.exports = { getCurrentVersion, getPublishedVersions };
