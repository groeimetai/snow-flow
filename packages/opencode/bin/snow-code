#!/usr/bin/env node

const childProcess = require("child_process")
const fs = require("fs")
const path = require("path")
const os = require("os")

function run(target) {
  const result = childProcess.spawnSync(target, process.argv.slice(2), {
    stdio: "inherit",
  })
  if (result.error) {
    console.error(result.error.message)
    process.exit(1)
  }
  const code = typeof result.status === "number" ? result.status : 0
  process.exit(code)
}

// Check for environment override
const envPath = process.env.SNOW_CODE_BIN_PATH || process.env.OPENCODE_BIN_PATH
if (envPath && fs.existsSync(envPath)) {
  run(envPath)
}

const scriptPath = fs.realpathSync(__filename)
const scriptDir = path.dirname(scriptPath)

const platformMap = {
  darwin: "darwin",
  linux: "linux",
  win32: "windows",
}
const archMap = {
  x64: "x64",
  arm64: "arm64",
  arm: "arm",
}

let platform = platformMap[os.platform()] || os.platform()
let arch = archMap[os.arch()] || os.arch()

const binaryName = platform === "windows" ? "snow-code.exe" : "snow-code"

// First check: binary in our own bin directory (from postinstall download)
// Only run if file is >100KB (actual compiled binary), not this launcher script (~2KB)
const localBinary = path.join(scriptDir, binaryName)
if (fs.existsSync(localBinary)) {
  const stats = fs.statSync(localBinary)
  if (stats.size > 100000) {
    run(localBinary)
  }
}

// Second check: look in node_modules for platform packages
const snowCodeBase = "snow-code-" + platform + "-" + arch

function findInNodeModules(startDir) {
  let current = startDir
  for (;;) {
    const modules = path.join(current, "node_modules")
    if (fs.existsSync(modules)) {
      const entries = fs.readdirSync(modules)
      for (const entry of entries) {
        if (entry.startsWith(snowCodeBase)) {
          const candidate = path.join(modules, entry, "bin", binaryName)
          if (fs.existsSync(candidate)) {
            return candidate
          }
        }
      }
    }
    const parent = path.dirname(current)
    if (parent === current) break
    current = parent
  }
}

const resolved = findInNodeModules(scriptDir)
if (resolved) {
  run(resolved)
}

console.error("snow-code: Binary not found for " + platform + "-" + arch)
console.error("Try running: npm rebuild snow-code")
console.error("Or download manually from: https://github.com/groeimetai/snow-flow/releases")
process.exit(1)
